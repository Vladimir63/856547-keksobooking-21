(()=>{"use strict";window.getRandomNumbers=function(e,t){const o=Math.ceil(e),n=Math.floor(t);return Math.floor(Math.random()*(n-o+1))+o},window.unique=function(e){let t=[];for(let o of e)t.includes(o)||t.push(o);return t},(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector(".map__pins"),o=["wifi","dishwasher","parking","washer","elevator","conditioner"],n=["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"],r=window.getRandomNumbers,i=window.unique,s=function(e){e.style.display="none"};window.getCreateCard=function(o){const n=document.createDocumentFragment();for(let t=0;t<o.length;t++){const r=e.cloneNode(!0),i=r.querySelector(".popup__title"),c=r.querySelector(".popup__text--address"),d=r.querySelector(".popup__text--price"),u=r.querySelector(".popup__type"),a=r.querySelector(".popup__text--capacity"),l=r.querySelector(".popup__text--time"),f=r.querySelector(".popup__features"),m=r.querySelector(".popup__description"),p=r.querySelector(".popup__photo"),w=r.querySelector(".popup__photos"),y=r.querySelector(".popup__avatar"),h=r.querySelector(".popup__close");r.setAttribute("id","card__"+o[t].id),r.classList.add("hidden"),h.addEventListener("click",(function(){r.classList.add("hidden")})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),r.classList.add("hidden"))})),i.textContent=""+o[t].offer.title,o[t].offer.title||s(i),c.textContent=""+o[t].offer.address,o[t].offer.address||s(c),d.textContent=o[t].offer.price+"₽/ночь",o[t].offer.price||s(d);const v={flat:"квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"};u.textContent=v[o[t].offer.type]||"",o[t].offer.type||s(u);let _="";1===o[t].offer.rooms?_=o[t].offer.rooms+" комната для ":o[t].offer.rooms>1&&o[t].offer.rooms<5?_=o[t].offer.rooms+" комнаты для ":o[t].offer.rooms>4&&(_=o[t].offer.rooms+" комнат для ");let g="";for(g=1===o[t].offer.guests?o[t].offer.guests+" гостя.":o[t].offer.guests+" гостей.",a.textContent=_+g,o[t].offer.rooms&&o[t].offer.guests||s(a),l.textContent=`Заезд после ${o[t].offer.checkin}, выезд до ${o[t].offer.checkuot}`,o[t].offer.checkin&&o[t].offer.checkuot||s(l),m.textContent=""+o[t].offer.description,o[t].offer.description||s(m),y.setAttribute("src",""+o[t].author.avatar),o[t].author.avatar||s(y);w.firstChild;)w.removeChild(w.lastChild);for(let e=0;e<o[t].offer.photos.length;e++){const n=p.cloneNode();n.setAttribute("src",""+o[t].offer.photos[e]),w.appendChild(n)}for(o[t].offer.photos.length||s(w);f.firstChild;)f.removeChild(f.lastChild);for(let e=0;e<o[t].offer.features.length;e++){const n=document.createElement("li");n.setAttribute("class","popup__feature popup__feature--"+o[t].offer.features[e]),f.appendChild(n)}o[t].offer.features.length||s(f),n.appendChild(r)}const r=t.querySelector(".map__filters-container");t.insertBefore(n,r)},window.removeBlock=s,window.createArrFeatures=function(){const e=[],t=r(0,o.length);for(let n=0;n<t;n++){const t=Math.floor(Math.random()*o.length);e.push(o[t])}return i(e)},window.createArrPhotos=function(){const e=[],t=r(0,n.length);for(let o=0;o<t;o++){const t=Math.floor(Math.random()*n.length);e.push(n[t])}return i(e)}})(),window.load=function(e,t){const o=window.xhr.createXhr(e,t);o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},window.upload=function(e,t,o){const n=window.xhr.createXhr(t,o);e&&(n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(e))},window.xhr={createXhr:function(e,t){let o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(function(){let n;switch(o.status){case 200:e(o.response);break;case 400:n="Неверный запрос";break;case 401:n="Пользователь не авторизован";break;case 404:n="Ничего не найдено";break;case 500:n="Внутренняя ошибка сервера";break;default:n=`Cтатус ответа: ${o.status} ${o.statusText}`}n&&t(n)})),o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){t(`Запрос не успел выполниться за ${o.timeout} мс`)})),o.timeout=1e4,o}},window.debounce=function(e){let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...o)}),500)}},(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=document.querySelector("#pin").content.querySelector(".map__pin"),n=function(e){const n=document.createDocumentFragment();e.forEach((function(e){const t=o.cloneNode(!0),r=t.querySelector("img");t.setAttribute("style",`left: ${e.location.x}px; top: ${e.location.y}px`),t.setAttribute("id",""+e.id),r.setAttribute("src",""+e.author.avatar),r.setAttribute("alt",""+e.offer.title),n.appendChild(t)})),t.appendChild(n)},r=function(){const e=t.querySelectorAll(".map__card");let o=Array.from(e);for(let e=0;e<o.length;e++)o[e].classList.add("hidden")};e.addEventListener("click",(function(e){let t=e.target;if("IMG"===t.tagName&&(t=t.parentNode),t.classList.contains("map__pin")&&!t.classList.contains("map__pin--main")){r();const e=t.getAttribute("id");document.querySelector("#card__"+e).classList.remove("hidden")}})),window.getRenderingPins=n,window.addHidden=r,window.removePins=function(){const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t=0;t<e.length;t++)e[t].remove()},window.renderPins=function(e){const t=e.slice(0,5);n(t)}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".ad-form"),o=document.querySelector(".map"),n=document.querySelector(".map__filters"),r=e.offsetLeft+31,i=e.offsetTop+22,s=window.getCreateCard,c=window.load,d=window.renderPins,u=function(t){0===t.button&&(m(),e.removeEventListener("mousedown",u),e.removeEventListener("keydown",a))},a=function(t){"Enter"===t.key&&(m(),e.removeEventListener("mousedown",u),e.removeEventListener("keydown",a))},l=function(e){for(let t=0;t<e.length;t++)e[t].id=t;s(e),d(e),window.offers=e},f=function(e){window.message.showError(e)},m=function(){o.classList.remove("map--faded"),t.classList.remove("ad-form--disabled"),n.classList.remove("ad-form--disabled");for(let e=0;e<t.children.length;e++)t.children[e].removeAttribute("disabled");for(let e=0;e<n.children.length;e++)n.children[e].removeAttribute("disabled");c(l,f),t.querySelector("#address").setAttribute("value",r+", "+i)};e.addEventListener("keydown",a),e.addEventListener("mousedown",u),window.activatePage=m,window.clearPage=function(){t.reset()},window.buttonMouseDownHandler=u,window.buttonKeyDownHandler=a,window.mapPin=e,window.WIDTH_MAIN_PIN=62,window.HEIGHT_MAIN_PIN=62,window.HEIGHT_MAIN_PIN_AFTER=22,window.LEFT_MAP_PIN=r,window.TOP_MAP_PIN_SUM=i,window.map=o,window.onSuccess=l,window.onError=f,window.mapFilters=n})(),(()=>{const e=document.querySelector("#title"),t=document.querySelector("#price"),o=document.querySelector("#address"),n=document.querySelector("#type"),r=document.querySelector("#timein"),i=document.querySelector("#timeout"),s=document.querySelector(".ad-form"),c=s.querySelector("#room_number"),d=s.querySelector("#capacity"),u=document.querySelector(".map__pin--main"),a=u.offsetLeft+31,l=u.offsetTop-31,f=window.mapFilters,m=document.querySelector(".ad-form__reset"),p=window.clearPage,w={bungalow:0,flat:1e3,house:5e3,palace:1e4};for(let e=0;e<s.children.length;e++)s.children[e].setAttribute("disabled","disabled");for(let e=0;e<f.children.length;e++)f.children[e].setAttribute("disabled","disabled");s.querySelector("#address").setAttribute("value",a+", "+l);const y=function(){s.setAttribute("action","https://javascript.pages.academy/keksobooking"),e.setAttribute("required","required"),e.setAttribute("minlength","30"),e.setAttribute("maxlength","100"),t.setAttribute("required","required"),t.setAttribute("max","1000000"),o.setAttribute("readonly","readonly")};y(),t.setAttribute("min",w[n.options[n.selectedIndex].value]),t.setAttribute("placeholder",w[n.options[n.selectedIndex].value]),n.addEventListener("change",(function(e){t.setAttribute("min",w[n.options[e.currentTarget.selectedIndex].value]),t.setAttribute("placeholder",w[n.options[e.currentTarget.selectedIndex].value])}));const h=function(e){"timeout"===e.currentTarget.name?r.options.selectedIndex=i.options.selectedIndex:i.options.selectedIndex=r.options.selectedIndex};r.addEventListener("change",h),i.addEventListener("change",h);const v=e=>{switch(e){case"1":e=1;break;case"2":e=2;break;case"3":e=3;break;case"100":e=100}return e},_=e=>{switch(e){case"1":e=1;break;case"2":e=2;break;case"3":e=3;break;case"0":e=100}return e},g=()=>((e,t)=>{switch(e){case 1:e!==t?d.setCustomValidity("1 комната для 1 гостя"):d.setCustomValidity("");break;case 2:e>=t?d.setCustomValidity(""):d.setCustomValidity("2 комнаты для 2 гостей или для 1 гостя");break;case 3:e>=t?d.setCustomValidity(""):d.setCustomValidity("3 комнаты для 3 гостей, для 2 гостей или для 1 гостя");break;case 100:e!==t?d.setCustomValidity("не для гостей"):d.setCustomValidity("")}})(v(c.value),_(d.value));g(),c.addEventListener("change",(()=>{g()})),d.addEventListener("change",(()=>{g()}));const b=function(){document.querySelector("#avatar").setAttribute("accept","image/*"),document.querySelector("#images").setAttribute("accept","image/*")};b(),s.addEventListener("submit",(function(e){window.upload(new FormData(s),(function(){})),e.preventDefault()})),s.addEventListener("submit",(function(e){e.preventDefault(),window.upload(new FormData(s),q,S)}));const q=function(e){window.message.showSuccess(e)},S=function(e){window.message.showError(e)};m.addEventListener("click",(function(e){e.preventDefault(),p()})),window.createAttributesForm=y,window.validationTime=h,window.checkRoomNumber=v,window.checkGuestNumber=_,window.setGuestNumbers=g,window.setImgFiles=b,window.addressForm=o})(),(()=>{let e,t=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("main");const r=window.activatePage,i=function(t){0===t.button&&(r(),e.removeEventListener("mousedown",i),e.removeEventListener("keydown",s))},s=function(t){"Enter"===t.key&&(r(),e.removeEventListener("mousedown",i),e.removeEventListener("keydown",s))},c=function(){let e=n.querySelector(".error");e&&(e.remove(),document.removeEventListener("keydown",u))},d=function(){let e=n.querySelector(".success");e&&(e.remove(),document.removeEventListener("keydown",u))},u=function(e){"Escape"===e.key&&(c(),d())};window.message={showError:function(o){let r=t.cloneNode(!0);e=r.querySelector(".error__button"),r.querySelector(".error__message").textContent=o,r.addEventListener("click",(function(){c()})),document.addEventListener("keydown",u),e.addEventListener("mousedown",i),e.addEventListener("keydown",s),n.appendChild(r)},showSuccess:function(){let e=o.cloneNode(!0);e.addEventListener("click",(function(){d()})),document.addEventListener("keydown",u),n.appendChild(e)}}})(),(()=>{const e=window.WIDTH_MAIN_PIN,t=window.HEIGHT_MAIN_PIN_AFTER,o=130-t,n=630-t,r=0-e/2,i=1200-e/2,s=window.mapPin,c=window.addressForm;s.addEventListener("mousedown",(d=>{d.preventDefault();let u={x:d.clientX,y:d.clientY};const a=d=>{d.preventDefault();let a=u.x-d.clientX,l=u.y-d.clientY;u={x:d.clientX,y:d.clientY};let f={x:s.offsetLeft-a,y:s.offsetTop-l};const m=o,p=n,w=r,y=i;f.x>=w&&f.x<=y&&(s.style.left=f.x+"px"),f.y>=m&&f.y<=p&&(s.style.top=f.y+"px"),f.y+t>n&&(f.y=n),f.y-t<o&&(f.y=o),f.x-e/2<r&&(f.x=r),f.x+e/2>i&&(f.x=i),c.value=`${f.x+e/2}, ${f.y+t}`},l=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)}))})(),(()=>{const e="any",t=window.mapFilters,o=document.querySelector("#housing-type"),n=document.querySelector("#housing-price"),r=document.querySelector("#housing-rooms"),i=document.querySelector("#housing-guests"),s=window.addHidden,c=window.renderPins,d=window.removePins,u={low:{min:0,max:9999},middle:{min:1e4,max:49999},high:{min:5e4,max:1/0}};t.addEventListener("change",(function(){s(),d(),window.debounce(a(window.offers))}));const a=function(t){const s=t.filter((function(t){return s=t,(o.value===e||s.offer.type===o.value)&&function(t){return r.value===e||t.offer.rooms.toString()===r.value}(t)&&function(t){return i.value===e||t.offer.guests.toString()===i.value}(t)&&function(t){return n.value===e||t.offer.price>=u[n.value].min&&t.offer.price<=u[n.value].max}(t)&&function(e){let t=document.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((function(t){return e.offer.features.indexOf(t.value)>=0}))}(t);var s}));c(s)}})()})();