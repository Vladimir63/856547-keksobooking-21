(()=>{"use strict";(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector(".map__pins"),o=function(e){e.style.display="none"};window.getCreateCard=function(n){const r=document.createDocumentFragment();for(let t=0;t<n.length;t++){const i=e.cloneNode(!0),s=i.querySelector(".popup__title"),d=i.querySelector(".popup__text--address"),c=i.querySelector(".popup__text--price"),a=i.querySelector(".popup__type"),u=i.querySelector(".popup__text--capacity"),l=i.querySelector(".popup__text--time"),m=i.querySelector(".popup__features"),f=i.querySelector(".popup__description"),w=i.querySelector(".popup__photo"),p=i.querySelector(".popup__photos"),y=i.querySelector(".popup__avatar"),v=i.querySelector(".popup__close");i.setAttribute("id","card__"+n[t].id),i.classList.add("hidden"),v.addEventListener("click",(function(){i.classList.add("hidden")})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),i.classList.add("hidden"))})),s.textContent=""+n[t].offer.title,n[t].offer.title||o(s),d.textContent=""+n[t].offer.address,n[t].offer.address||o(d),c.textContent=n[t].offer.price+"₽/ночь",n[t].offer.price||o(c);const h={flat:"квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"};a.textContent=h[n[t].offer.type]||"",n[t].offer.type||o(a);let _="";1===n[t].offer.rooms?_=n[t].offer.rooms+" комната для ":n[t].offer.rooms>1&&n[t].offer.rooms<5?_=n[t].offer.rooms+" комнаты для ":n[t].offer.rooms>4&&(_=n[t].offer.rooms+" комнат для ");let b="";for(b=1===n[t].offer.guests?n[t].offer.guests+" гостя.":n[t].offer.guests+" гостей.",u.textContent=_+b,n[t].offer.rooms&&n[t].offer.guests||o(u),l.textContent=`Заезд после ${n[t].offer.checkin}, выезд до ${n[t].offer.checkuot}`,n[t].offer.checkin&&n[t].offer.checkuot||o(l),f.textContent=""+n[t].offer.description,n[t].offer.description||o(f),y.setAttribute("src",""+n[t].author.avatar),n[t].author.avatar||o(y);p.firstChild;)p.removeChild(p.lastChild);for(let e=0;e<n[t].offer.photos.length;e++){const o=w.cloneNode();o.setAttribute("src",""+n[t].offer.photos[e]),p.appendChild(o)}for(n[t].offer.photos.length||o(p);m.firstChild;)m.removeChild(m.lastChild);for(let e=0;e<n[t].offer.features.length;e++){const o=document.createElement("li");o.setAttribute("class","popup__feature popup__feature--"+n[t].offer.features[e]),m.appendChild(o)}n[t].offer.features.length||o(m),r.appendChild(i)}const i=t.querySelector(".map__filters-container");t.insertBefore(r,i)},window.removeBlock=o,window.removeCards=function(){const e=t.querySelectorAll(".map__card");for(let t=0;t<e.length;t++)e[t].remove()}})(),window.load=function(e,t){const o=window.xhr.createXhr(e,t);o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},window.upload=function(e,t,o){const n=window.xhr.createXhr(t,o);e&&(n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(e))},window.xhr={createXhr:function(e,t){let o=new XMLHttpRequest;return o.responseType="json",o.addEventListener("load",(function(){let n;switch(o.status){case 200:e(o.response);break;case 400:n="Неверный запрос";break;case 401:n="Пользователь не авторизован";break;case 404:n="Ничего не найдено";break;case 500:n="Внутренняя ошибка сервера";break;default:n=`Cтатус ответа: ${o.status} ${o.statusText}`}n&&t(n)})),o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){t(`Запрос не успел выполниться за ${o.timeout} мс`)})),o.timeout=1e4,o}},window.debounce=function(e){let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...o)}),500)}},(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pins"),o=document.querySelector("#pin").content.querySelector(".map__pin"),n=document.querySelector(".map__pin--main"),r=function(){const e=t.querySelectorAll(".map__card");let o=Array.from(e);for(let e=0;e<o.length;e++)o[e].classList.add("hidden")},i=window.LEFT_MAP_PIN,s=window.TOP_MAP_PIN;e.addEventListener("click",(function(e){let t=e.target;if("IMG"===t.tagName&&(t=t.parentNode),t.classList.contains("map__pin")&&!t.classList.contains("map__pin--main")){r();const e=t.getAttribute("id");document.querySelector("#card__"+e).classList.remove("hidden")}})),window.addHidden=r,window.removePins=function(){const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t=0;t<e.length;t++)e[t].remove()},window.renderPins=function(e){!function(e){const n=document.createDocumentFragment();e.forEach((function(e){const t=o.cloneNode(!0),r=t.querySelector("img");t.setAttribute("style",`left: ${e.location.x}px; top: ${e.location.y}px`),t.setAttribute("id",""+e.id),r.setAttribute("src",""+e.author.avatar),r.setAttribute("alt",""+e.offer.title),n.appendChild(t)})),t.appendChild(n)}(e.slice(0,5))},window.setDefaultCoords=function(){n.style.top=s+"px",n.style.left=i+"px"}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".ad-form"),o=document.querySelector(".map"),n=document.querySelector(".map__filters"),r=Math.ceil(e.offsetLeft+32.5),i=Math.ceil(e.offsetTop+32.5),s=Math.ceil(e.offsetTop+65+22),d=window.getCreateCard,c=window.load,a=window.renderPins,u=window.removePins,l=window.removeCards,m=window.setDefaultCoords,f=function(t){0===t.button&&(v(),e.removeEventListener("mousedown",f),e.removeEventListener("keydown",w))},w=function(t){"Enter"===t.key&&(v(),e.removeEventListener("mousedown",f),e.removeEventListener("keydown",w))},p=function(e){for(let t=0;t<e.length;t++)e[t].id=t;d(e),a(e),window.offers=e},y=function(e){window.message.showError(e)},v=function(){o.classList.remove("map--faded"),t.classList.remove("ad-form--disabled"),n.classList.remove("ad-form--disabled");for(let e=0;e<t.children.length;e++)t.children[e].removeAttribute("disabled");for(let e=0;e<n.children.length;e++)n.children[e].removeAttribute("disabled");c(p,y),t.querySelector("#address").setAttribute("value",r+", "+s)};e.addEventListener("keydown",w),e.addEventListener("mousedown",f),window.activatePage=v,window.buttonMouseDownHandler=f,window.buttonKeyDownHandler=w,window.mapPin=e,window.WIDTH_MAIN_PIN=65,window.HEIGHT_MAIN_PIN=65,window.HEIGHT_MAIN_PIN_AFTER=22,window.LEFT_MAP_PIN=r,window.TOP_MAP_PIN=i,window.TOP_MAP_PIN_SUM=s,window.map=o,window.onSuccess=p,window.onError=y,window.mapFilters=n,window.deactivatePage=function(){n.reset(),t.reset(),o.classList.add("map--faded"),t.classList.add("ad-form--disabled"),u(),l();for(let e=0;e<t.children.length;e++)t.children[e].setAttribute("disabled","disabled");for(let e=0;e<n.children.length;e++)n.children[e].setAttribute("disabled","disabled");m(),c(p,y),t.querySelector("#address").setAttribute("value",r+", "+i)}})(),(()=>{const e=document.querySelector("#title"),t=document.querySelector("#price"),o=document.querySelector("#address"),n=document.querySelector("#type"),r=document.querySelector("#timein"),i=document.querySelector("#timeout"),s=document.querySelector(".ad-form"),d=s.querySelector("#room_number"),c=s.querySelector("#capacity"),a=document.querySelector(".map__pin--main"),u=window.LEFT_MAP_PIN,l=window.TOP_MAP_PIN,m=window.mapFilters,f=document.querySelector(".ad-form__reset"),w=window.deactivatePage,p={bungalow:0,flat:1e3,house:5e3,palace:1e4};for(let e=0;e<s.children.length;e++)s.children[e].setAttribute("disabled","disabled");for(let e=0;e<m.children.length;e++)m.children[e].setAttribute("disabled","disabled");s.querySelector("#address").setAttribute("value",u+", "+l);const y=function(){s.setAttribute("action","https://javascript.pages.academy/keksobooking"),e.setAttribute("required","required"),e.setAttribute("minlength","30"),e.setAttribute("maxlength","100"),t.setAttribute("required","required"),t.setAttribute("max","1000000"),o.setAttribute("readonly","readonly")};y(),t.setAttribute("min",p[n.options[n.selectedIndex].value]),t.setAttribute("placeholder",p[n.options[n.selectedIndex].value]),n.addEventListener("change",(function(e){t.setAttribute("min",p[n.options[e.currentTarget.selectedIndex].value]),t.setAttribute("placeholder",p[n.options[e.currentTarget.selectedIndex].value])}));const v=function(e){"timeout"===e.currentTarget.name?r.options.selectedIndex=i.options.selectedIndex:i.options.selectedIndex=r.options.selectedIndex};r.addEventListener("change",v),i.addEventListener("change",v);const h=e=>{switch(e){case"1":e=1;break;case"2":e=2;break;case"3":e=3;break;case"100":e=100}return e},_=e=>{switch(e){case"1":e=1;break;case"2":e=2;break;case"3":e=3;break;case"0":e=100}return e},b=()=>((e,t)=>{switch(e){case 1:e!==t?c.setCustomValidity("1 комната для 1 гостя"):c.setCustomValidity("");break;case 2:e>=t?c.setCustomValidity(""):c.setCustomValidity("2 комнаты для 2 гостей или для 1 гостя");break;case 3:e>=t?c.setCustomValidity(""):c.setCustomValidity("3 комнаты для 3 гостей, для 2 гостей или для 1 гостя");break;case 100:e!==t?c.setCustomValidity("не для гостей"):c.setCustomValidity("")}})(h(d.value),_(c.value));b(),d.addEventListener("change",(()=>{b()})),c.addEventListener("change",(()=>{b()}));const g=function(){document.querySelector("#avatar").setAttribute("accept","image/*"),document.querySelector("#images").setAttribute("accept","image/*")};g(),s.addEventListener("submit",(function(e){e.preventDefault(),w(),window.upload(new FormData(s),S,q)}));const S=function(e){window.message.showSuccess(e)},q=function(e){window.message.showError(e)},E=function(e){"Enter"===e.key&&(w(),a.removeEventListener("mousedown",L),a.removeEventListener("keydown",E))},L=function(e){0===e.button&&(w(),a.removeEventListener("mousedown",L),a.removeEventListener("keydown",E))};f.addEventListener("keydown",E),f.addEventListener("mousedown",L),window.createAttributesForm=y,window.validationTime=v,window.checkRoomNumber=h,window.checkGuestNumber=_,window.setGuestNumbers=b,window.setImgFiles=g,window.addressForm=o})(),(()=>{let e,t=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("main");const r=window.activatePage,i=function(t){0===t.button&&(r(),e.removeEventListener("mousedown",i),e.removeEventListener("keydown",s))},s=function(t){"Enter"===t.key&&(r(),e.removeEventListener("mousedown",i),e.removeEventListener("keydown",s))},d=function(){let e=n.querySelector(".error");e&&(e.remove(),document.removeEventListener("keydown",a))},c=function(){let e=n.querySelector(".success");e&&(e.remove(),document.removeEventListener("keydown",a))},a=function(e){"Escape"===e.key&&(d(),c())};window.message={showError:function(o){let r=t.cloneNode(!0);e=r.querySelector(".error__button"),r.querySelector(".error__message").textContent=o,r.addEventListener("click",(function(){d()})),document.addEventListener("keydown",a),e.addEventListener("mousedown",i),e.addEventListener("keydown",s),n.appendChild(r)},showSuccess:function(){let e=o.cloneNode(!0);e.addEventListener("click",(function(){c()})),document.addEventListener("keydown",a),n.appendChild(e)}}})(),(()=>{const e=window.WIDTH_MAIN_PIN,t=window.HEIGHT_MAIN_PIN,o=window.HEIGHT_MAIN_PIN_AFTER,n=130-o-t,r=630-o-t,i=0-Math.ceil(e/2),s=1200-Math.ceil(e/2),d=window.mapPin,c=window.addressForm;d.addEventListener("mousedown",(a=>{a.preventDefault();let u={x:a.clientX,y:a.clientY};const l=a=>{a.preventDefault();let l=u.x-a.clientX,m=u.y-a.clientY;u={x:a.clientX,y:a.clientY};let f={x:d.offsetLeft-l,y:d.offsetTop-m};const w=n,p=r,y=i,v=s;f.x>=y&&f.x<=v&&(d.style.left=f.x+"px"),f.y>=w&&f.y<=p&&(d.style.top=f.y+"px"),f.y+o>r&&(f.y=r),f.y-o<n&&(f.y=n),f.x<i&&(f.x=i),f.x>s&&(f.x=s),c.value=`${f.x+Math.ceil(e/2)}, ${f.y+t+o}`},m=e=>{e.preventDefault(),document.removeEventListener("mousemove",l),document.removeEventListener("mouseup",m)};document.addEventListener("mousemove",l),document.addEventListener("mouseup",m)}))})(),(()=>{const e="any",t=window.mapFilters,o=document.querySelector("#housing-type"),n=document.querySelector("#housing-price"),r=document.querySelector("#housing-rooms"),i=document.querySelector("#housing-guests"),s=window.addHidden,d=window.renderPins,c=window.removePins,a={low:{min:0,max:9999},middle:{min:1e4,max:49999},high:{min:5e4,max:1/0}};t.addEventListener("change",(function(){s(),c(),window.offers,window.debounce(u)}));const u=function(t){const s=t.filter((function(t){return s=t,(o.value===e||s.offer.type===o.value)&&function(t){return r.value===e||t.offer.rooms.toString()===r.value}(t)&&function(t){return i.value===e||t.offer.guests.toString()===i.value}(t)&&function(t){return n.value===e||t.offer.price>=a[n.value].min&&t.offer.price<=a[n.value].max}(t)&&function(e){let t=document.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((function(t){return e.offer.features.indexOf(t.value)>=0}))}(t);var s}));d(s)}})()})();