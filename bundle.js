(()=>{"use strict";(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.querySelector(".map__pins"),n=function(e){e.style.display="none"};window.card={getCreateCard:function(o){const r=document.createDocumentFragment();for(let t=0;t<o.length;t++){const i=e.cloneNode(!0),s=i.querySelector(".popup__title"),d=i.querySelector(".popup__text--address"),a=i.querySelector(".popup__text--price"),c=i.querySelector(".popup__type"),u=i.querySelector(".popup__text--capacity"),l=i.querySelector(".popup__text--time"),m=i.querySelector(".popup__features"),p=i.querySelector(".popup__description"),f=i.querySelector(".popup__photo"),w=i.querySelector(".popup__photos"),y=i.querySelector(".popup__avatar"),v=i.querySelector(".popup__close");i.setAttribute("id","card__"+o[t].id),i.classList.add("hidden"),v.addEventListener("click",(function(){i.classList.add("hidden")})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&(e.preventDefault(),i.classList.add("hidden"))})),s.textContent=""+o[t].offer.title,o[t].offer.title||n(s),d.textContent=""+o[t].offer.address,o[t].offer.address||n(d),a.textContent=o[t].offer.price+"₽/ночь",o[t].offer.price||n(a);const _={flat:"квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"};c.textContent=_[o[t].offer.type]||"",o[t].offer.type||n(c);let h="";1===o[t].offer.rooms?h=o[t].offer.rooms+" комната для ":o[t].offer.rooms>1&&o[t].offer.rooms<5?h=o[t].offer.rooms+" комнаты для ":o[t].offer.rooms>4&&(h=o[t].offer.rooms+" комнат для ");let b="";for(b=1===o[t].offer.guests?o[t].offer.guests+" гостя.":o[t].offer.guests+" гостей.",u.textContent=h+b,o[t].offer.rooms&&o[t].offer.guests||n(u),l.textContent=`Заезд после ${o[t].offer.checkin}, выезд до ${o[t].offer.checkuot}`,o[t].offer.checkin&&o[t].offer.checkuot||n(l),p.textContent=""+o[t].offer.description,o[t].offer.description||n(p),y.setAttribute("src",""+o[t].author.avatar),o[t].author.avatar||n(y);w.firstChild;)w.removeChild(w.lastChild);for(let e=0;e<o[t].offer.photos.length;e++){const n=f.cloneNode();n.setAttribute("src",""+o[t].offer.photos[e]),w.appendChild(n)}for(o[t].offer.photos.length||n(w);m.firstChild;)m.removeChild(m.lastChild);for(let e=0;e<o[t].offer.features.length;e++){const n=document.createElement("li");n.setAttribute("class","popup__feature popup__feature--"+o[t].offer.features[e]),m.appendChild(n)}o[t].offer.features.length||n(m),r.appendChild(i)}const i=t.querySelector(".map__filters-container");t.insertBefore(r,i)},removeCards:function(){const e=t.querySelectorAll(".map__card");for(let t=0;t<e.length;t++)e[t].remove()}}})(),window.xhr={createRequest:function(e,t){const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(function(){let o;switch(n.status){case 200:e(n.response);break;case 400:o="Неверный запрос";break;case 401:o="Пользователь не авторизован";break;case 404:o="Ничего не найдено";break;case 500:o="Внутренняя ошибка сервера";break;default:o=`Cтатус ответа: ${n.status} ${n.statusText}`}o&&t(o)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.addEventListener("timeout",(function(){t(`Запрос не успел выполниться за ${n.timeout} мс`)})),n.timeout=1e4,n}},window.load=function(e,t){const n=window.xhr.createRequest(e,t);n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},window.upload=function(e,t,n){const o=window.xhr.createRequest(t,n);e&&(o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e))},window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){return e(...n)}),500)}},(()=>{const e=document.querySelector(".map__pin--main"),t=e.offsetLeft,n=e.offsetTop,o=document.querySelector(".map"),r=document.querySelector(".map__pins"),i=document.querySelector("#pin").content.querySelector(".map__pin"),s=function(){const e=r.querySelectorAll(".map__card"),t=Array.from(e);for(let e=0;e<t.length;e++)t[e].classList.add("hidden")};o.addEventListener("click",(function(e){let t=e.target;if("IMG"===t.tagName&&(t=t.parentNode),t.classList.contains("map__pin")&&!t.classList.contains("map__pin--main")){s();const e=t.getAttribute("id");document.querySelector("#card__"+e).classList.remove("hidden")}})),window.pin={addHidden:s,removePins:function(){const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t=0;t<e.length;t++)e[t].remove()},renderPins:function(e){!function(e){const t=document.createDocumentFragment();e.forEach((function(e){const n=i.cloneNode(!0),o=n.querySelector("img");n.setAttribute("style",`left: ${e.location.x}px; top: ${e.location.y}px`),n.setAttribute("id",""+e.id),o.setAttribute("src",""+e.author.avatar),o.setAttribute("alt",""+e.offer.title),t.appendChild(n)})),r.appendChild(t)}(e.slice(0,5))},setDefaultCoords:function(){e.style.top=n+"px",e.style.left=t+"px"},mapPin:e,map:o,MAX_PIN_ON_MAP:5}})(),(()=>{const e=Math.ceil(window.pin.mapPin.offsetLeft+32.5),t=Math.ceil(window.pin.mapPin.offsetTop+32.5),n=Math.ceil(window.pin.mapPin.offsetTop+65+22),o=document.querySelector(".ad-form"),r=document.querySelector(".map__filters"),i=function(e){0===e.button&&(a(),window.pin.mapPin.removeEventListener("mousedown",i),window.pin.mapPin.removeEventListener("keydown",s))},s=function(e){"Enter"===e.key&&(a(),window.pin.mapPin.removeEventListener("mousedown",i),window.pin.mapPin.removeEventListener("keydown",s))},d=function(e){for(let t=0;t<e.length;t++)e[t].id=t;window.card.getCreateCard(e),window.pin.renderPins(e),window.offers=e},a=function(){window.pin.map.classList.remove("map--faded"),o.classList.remove("ad-form--disabled"),r.classList.remove("ad-form--disabled");for(let e=0;e<o.children.length;e++)o.children[e].removeAttribute("disabled");for(let e=0;e<r.children.length;e++)r.children[e].removeAttribute("disabled");window.load(d,window.message.showError),o.querySelector("#address").setAttribute("value",e+", "+n),window.form.setGuestNumbers()};function c(){window.pin.mapPin.addEventListener("keydown",s),window.pin.mapPin.addEventListener("mousedown",i)}c(),window.map={activatePage:a,WIDTH_MAIN_PIN:65,HEIGHT_MAIN_PIN:65,HEIGHT_MAIN_PIN_AFTER:22,LEFT_MAP_PIN:e,TOP_MAP_PIN:t,TOP_MAP_PIN_SUM:n,mapFilters:r,deactivatePage:function(){r.reset(),o.reset(),window.pin.map.classList.add("map--faded"),o.classList.add("ad-form--disabled"),window.pin.removePins(),window.card.removeCards();for(let e=0;e<o.children.length;e++)o.children[e].setAttribute("disabled","disabled");for(let e=0;e<r.children.length;e++)r.children[e].setAttribute("disabled","disabled");window.pin.setDefaultCoords(),o.querySelector("#address").setAttribute("value",e+", "+t),c()},onSuccess:d}})(),(()=>{const e=document.querySelector("#title"),t=document.querySelector("#price"),n=document.querySelector("#address"),o=document.querySelector("#type"),r=document.querySelector("#timein"),i=document.querySelector("#timeout"),s=document.querySelector(".ad-form"),d=s.querySelector("#room_number"),a=s.querySelector("#capacity"),c=document.querySelector(".ad-form__reset"),u={bungalow:0,flat:1e3,house:5e3,palace:1e4};for(let e=0;e<s.children.length;e++)s.children[e].setAttribute("disabled","disabled");for(let e=0;e<window.map.mapFilters.children.length;e++)window.map.mapFilters.children[e].setAttribute("disabled","disabled");s.querySelector("#address").setAttribute("value",window.map.LEFT_MAP_PIN+", "+window.map.TOP_MAP_PIN),s.setAttribute("action","https://javascript.pages.academy/keksobooking"),e.setAttribute("required","required"),e.setAttribute("minlength","30"),e.setAttribute("maxlength","100"),t.setAttribute("required","required"),t.setAttribute("max","1000000"),n.setAttribute("readonly","readonly"),t.setAttribute("min",u[o.value]),t.setAttribute("placeholder",u[o.value]),o.addEventListener("change",(function(){t.setAttribute("min",u[o.value]),t.setAttribute("placeholder",u[o.value])}));const l=function(e){"timeout"===e.currentTarget.name?r.options.selectedIndex=i.options.selectedIndex:i.options.selectedIndex=r.options.selectedIndex};r.addEventListener("change",l),i.addEventListener("change",l);const m=()=>((e,t)=>{switch(e){case 1:e!==t?a.setCustomValidity("1 комната для 1 гостя"):a.setCustomValidity("");break;case 2:e>=t?a.setCustomValidity(""):a.setCustomValidity("2 комнаты для 2 гостей или для 1 гостя");break;case 3:e>=t?a.setCustomValidity(""):a.setCustomValidity("3 комнаты для 3 гостей, для 2 гостей или для 1 гостя");break;case 100:e!==t?a.setCustomValidity("не для гостей"):a.setCustomValidity("")}})((e=>{switch(e){case"1":e=1;break;case"2":e=2;break;case"3":e=3;break;case"100":e=100}return e})(d.value),(e=>{switch(e){case"1":e=1;break;case"2":e=2;break;case"3":e=3;break;case"0":e=100}return e})(a.value));d.addEventListener("change",(()=>{m()})),a.addEventListener("change",(()=>{m()})),document.querySelector("#avatar").setAttribute("accept","image/*"),document.querySelector("#images").setAttribute("accept","image/*"),s.addEventListener("submit",(function(e){e.preventDefault(),window.upload(new FormData(s),window.message.showSuccess,window.message.showError),window.map.deactivatePage()}));const p=function(e){"Enter"===e.key&&(window.map.deactivatePage(),window.pin.mapPin.removeEventListener("mousedown",f),window.pin.mapPin.removeEventListener("keydown",p))},f=function(e){0===e.button&&(window.map.deactivatePage(),window.pin.mapPin.removeEventListener("mousedown",f),window.pin.mapPin.removeEventListener("keydown",p))};c.addEventListener("keydown",p),c.addEventListener("mousedown",f),window.form={setGuestNumbers:m},window.addressForm=n})(),(()=>{const e=document.querySelector("#error").content.querySelector(".error"),t=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("main");let o;const r=function(e){0===e.button&&(window.map.activatePage(),o.removeEventListener("mousedown",r),o.removeEventListener("keydown",i))},i=function(e){"Enter"===e.key&&(window.map.activatePage(),o.removeEventListener("mousedown",r),o.removeEventListener("keydown",i))},s=function(){const e=n.querySelector(".error");e&&(e.remove(),document.removeEventListener("keydown",a))},d=function(){const e=n.querySelector(".success");e&&(e.remove(),document.removeEventListener("keydown",a))},a=function(e){"Escape"===e.key&&(s(),d())};window.message={showError:function(t){const d=e.cloneNode(!0);o=d.querySelector(".error__button"),d.querySelector(".error__message").textContent=t,d.addEventListener("click",(function(){s()})),document.addEventListener("keydown",a),o.addEventListener("mousedown",r),o.addEventListener("keydown",i),n.appendChild(d)},showSuccess:function(){const e=t.cloneNode(!0);e.addEventListener("click",(function(){d()})),document.addEventListener("keydown",a),n.appendChild(e)}}})(),(()=>{const e=130-window.map.HEIGHT_MAIN_PIN_AFTER-window.map.HEIGHT_MAIN_PIN,t=630-window.map.HEIGHT_MAIN_PIN_AFTER-window.map.HEIGHT_MAIN_PIN,n=0-Math.ceil(window.map.WIDTH_MAIN_PIN/2),o=1200-Math.ceil(window.map.WIDTH_MAIN_PIN/2),r=window.addressForm;window.pin.mapPin.addEventListener("mousedown",(i=>{i.preventDefault();let s={x:i.clientX,y:i.clientY};const d=i=>{i.preventDefault();let d=s.x-i.clientX,a=s.y-i.clientY;s={x:i.clientX,y:i.clientY};let c={x:window.pin.mapPin.offsetLeft-d,y:window.pin.mapPin.offsetTop-a};const u=e,l=t,m=n,p=o;c.x>=m&&c.x<=p&&(window.pin.mapPin.style.left=c.x+"px"),c.y>=u&&c.y<=l&&(window.pin.mapPin.style.top=c.y+"px"),c.y+window.map.HEIGHT_MAIN_PIN_AFTER>t&&(c.y=t),c.y-window.map.HEIGHT_MAIN_PIN_AFTER<e&&(c.y=e),c.x<n&&(c.x=n),c.x>o&&(c.x=o),r.value=`${c.x+Math.ceil(window.map.WIDTH_MAIN_PIN/2)}, ${c.y+window.map.HEIGHT_MAIN_PIN+window.map.HEIGHT_MAIN_PIN_AFTER}`},a=e=>{e.preventDefault(),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",a)}))})(),(()=>{const e="any",t=document.querySelector("#housing-type"),n=document.querySelector("#housing-price"),o=document.querySelector("#housing-rooms"),r=document.querySelector("#housing-guests"),i={low:{min:0,max:9999},middle:{min:1e4,max:49999},high:{min:5e4,max:1/0}},s=function(t){return o.value===e||t.offer.rooms.toString()===o.value},d=function(t){return r.value===e||t.offer.guests.toString()===r.value},a=function(t){return n.value===e||t.offer.price>=i[n.value].min&&t.offer.price<=i[n.value].max},c=function(e){const t=document.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((function(t){return e.offer.features.indexOf(t.value)>=0}))},u=window.debounce((function(n){const o=[];for(let i=0;i<n.length;i++){const u=n[i];if(r=u,(t.value===e||r.offer.type===t.value)&&s(u)&&d(u)&&a(u)&&c(u)&&(o.push(u),n.length===window.pin.MAX_PIN_ON_MAP))break}var r;window.pin.renderPins(o)}));window.map.mapFilters.addEventListener("change",(function(){window.pin.addHidden(),window.pin.removePins(),u(window.offers)}))})()})();